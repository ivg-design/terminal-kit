<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cascade Layers Demo - Understanding @layer for DSD</title>
    <style>
        body {
            padding: 2rem;
            background: #000;
            color: #0f0;
            font-family: monospace;
        }

        .section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #0f0;
        }

        pre {
            background: #111;
            padding: 1rem;
            overflow-x: auto;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <h1>Understanding Cascade Layers (@layer) for DSD</h1>

    <div class="section">
        <h2>The Problem: Style Source Conflicts</h2>
        <p>When a component has both DSD styles AND JavaScript adds adoptedStyleSheets:</p>
        <pre>
Timeline:
1. Browser parses HTML → DSD <style> applied (red button)
2. JavaScript loads → adoptedStyleSheets added (green button)
3. USER SEES: Flash from red to green! (FOUC)
        </pre>
    </div>

    <div class="section">
        <h2>Demo 1: WITHOUT Cascade Layers (Problem)</h2>

        <div id="without-layers-container"></div>

        <button onclick="addWithoutLayers()">Add Component WITHOUT Layers</button>
        <button onclick="simulateAdoptedStylesWithout()">Simulate JS Adding Styles</button>

        <pre id="without-log">Click buttons to see the problem...</pre>
    </div>

    <div class="section">
        <h2>Demo 2: WITH Cascade Layers (Solution)</h2>

        <div id="with-layers-container"></div>

        <button onclick="addWithLayers()">Add Component WITH Layers</button>
        <button onclick="simulateAdoptedStylesWith()">Simulate JS Adding Styles</button>

        <pre id="with-log">Click buttons to see the solution...</pre>
    </div>

    <div class="section">
        <h2>How Cascade Layers Work</h2>

        <h3>1. Define Layer Order (First Declaration Wins)</h3>
        <pre>
/* Whoever defines the order first sets it for the entire document */
@layer runtime, dsd;  /* runtime has LOWER priority, dsd has HIGHER priority */
        </pre>

        <h3>2. Assign Styles to Layers</h3>
        <pre>
/* DSD Template Styles */
@layer dsd {
    button {
        background: red;   /* This will WIN even if added first */
        color: white;
    }
}

/* JavaScript Added Styles */
@layer runtime {
    button {
        background: green; /* This will LOSE even if added later */
        color: yellow;
    }
}
        </pre>

        <h3>3. The Priority Rules</h3>
        <div class="demo-grid">
            <div>
                <h4>Normal Rules:</h4>
                <ul>
                    <li>Later layers WIN</li>
                    <li>dsd > runtime</li>
                    <li>Specificity still matters WITHIN a layer</li>
                </ul>
            </div>
            <div>
                <h4>!important Rules (Reversed!):</h4>
                <ul>
                    <li>Earlier layers WIN</li>
                    <li>runtime !important > dsd !important</li>
                    <li>Use sparingly!</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Real Component Example</h2>
        <pre>
&lt;t-btn variant="danger"&gt;
    &lt;template shadowrootmode="open"&gt;
        &lt;style&gt;
            /* Define layer order - DSD wins */
            @layer runtime, theme, dsd;

            /* High priority DSD styles */
            @layer dsd {
                :host button {
                    padding: 0.5em 1em;
                    background: #00ff00;
                    color: #000;
                }

                :host([variant="danger"]) button {
                    background: #ff0000;
                    color: #fff;
                }
            }

            /* Medium priority theme overrides */
            @layer theme {
                :host([theme="dark"]) button {
                    filter: brightness(0.8);
                }
            }

            /* Low priority runtime styles */
            @layer runtime {
                /* Empty - will be filled by adoptedStyleSheets */
            }
        &lt;/style&gt;
        &lt;button&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/button&gt;
    &lt;/template&gt;
    Delete
&lt;/t-btn&gt;
        </pre>

        <p>Then in JavaScript:</p>
        <pre>
// Component's connectedCallback
const sheet = new CSSStyleSheet();
sheet.replaceSync(`
    @layer runtime {
        /* These styles will have LOWER priority than DSD */
        button {
            background: green; /* Won't override DSD red */
            transform: scale(1);
            transition: transform 0.2s;
        }

        button:hover {
            transform: scale(1.05); /* This WILL work - no conflict */
        }
    }
`);
this.shadowRoot.adoptedStyleSheets = [sheet];
        </pre>
    </div>

    <div class="section">
        <h2>The Magic: No More FOUC!</h2>
        <ol>
            <li><strong>Browser parses HTML</strong> → DSD styles in @layer dsd (red button)</li>
            <li><strong>JavaScript loads</strong> → Adds adoptedStyleSheets in @layer runtime</li>
            <li><strong>Result</strong>: Button STAYS red! No flash! DSD layer wins!</li>
        </ol>

        <h3>Key Benefits:</h3>
        <ul>
            <li>✅ DSD styles always win for initial paint</li>
            <li>✅ JavaScript can still add non-conflicting styles</li>
            <li>✅ Animations and hover effects work fine</li>
            <li>✅ No specificity wars</li>
            <li>✅ Predictable and maintainable</li>
        </ul>
    </div>

    <script>
        // Demo WITHOUT cascade layers
        function addWithoutLayers() {
            const container = document.getElementById('without-layers-container');
            container.innerHTML = `
                <style>
                    #demo-btn-without {
                        padding: 1em 2em;
                        background: red;
                        color: white;
                        border: none;
                        cursor: pointer;
                        margin: 1rem 0;
                    }
                </style>
                <button id="demo-btn-without">Button (Red Initially)</button>
            `;

            document.getElementById('without-log').textContent =
                'Added button with red background (DSD simulation)\n' +
                'Now click "Simulate JS Adding Styles" to see FOUC...';
        }

        function simulateAdoptedStylesWithout() {
            // Simulate adoptedStyleSheets by adding a new style tag
            const style = document.createElement('style');
            style.textContent = `
                #demo-btn-without {
                    /* This overrides because it comes later! */
                    background: green;
                    color: yellow;
                }
            `;
            document.head.appendChild(style);

            document.getElementById('without-log').textContent =
                'JavaScript added green background\n' +
                'PROBLEM: Button flashed from red to green! (FOUC)\n' +
                'Later styles win with equal specificity!';
        }

        // Demo WITH cascade layers
        function addWithLayers() {
            const container = document.getElementById('with-layers-container');
            container.innerHTML = `
                <style>
                    /* Define layer order first */
                    @layer runtime, dsd;

                    /* DSD styles in higher priority layer */
                    @layer dsd {
                        #demo-btn-with {
                            padding: 1em 2em;
                            background: red;
                            color: white;
                            border: none;
                            cursor: pointer;
                            margin: 1rem 0;
                        }
                    }
                </style>
                <button id="demo-btn-with">Button (Red Forever)</button>
            `;

            document.getElementById('with-log').textContent =
                'Added button with red background in @layer dsd\n' +
                'Now click "Simulate JS Adding Styles"...';
        }

        function simulateAdoptedStylesWith() {
            // Simulate adoptedStyleSheets with layers
            const style = document.createElement('style');
            style.textContent = `
                @layer runtime {
                    #demo-btn-with {
                        /* This WON'T override despite coming later! */
                        background: green;
                        color: yellow;

                        /* But we can add non-conflicting styles */
                        transform: scale(1);
                        transition: transform 0.2s;
                    }

                    #demo-btn-with:hover {
                        transform: scale(1.1);
                    }
                }
            `;
            document.head.appendChild(style);

            document.getElementById('with-log').textContent =
                'JavaScript added green background in @layer runtime\n' +
                'SUCCESS: Button STAYS red! No FOUC!\n' +
                '@layer dsd has higher priority than @layer runtime\n' +
                'But hover animation was added successfully!';
        }
    </script>
</body>
</html>