<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDynamicControlsLit - Component Demo</title>
    <script src="../js/utils/accent-init.js"></script>
    <link rel="stylesheet" href="../css/demo-template.css">
    <link rel="stylesheet" href="../css/components/t-clr-iro.css">

    <style>
        .value-monitor {
            margin-top: 12px;
            padding: 12px;
            background: var(--terminal-black);
            border: 1px solid var(--terminal-gray-dark);
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: #888;
        }

        .value-monitor-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            color: var(--terminal-green);
        }

        /* Styled scrollbars for value monitor */
        .value-monitor::-webkit-scrollbar {
            width: 8px;
        }

        .value-monitor::-webkit-scrollbar-track {
            background: var(--terminal-gray-darkest, #1a1a1a);
            border: 1px solid var(--terminal-gray-light, #333);
        }

        .value-monitor::-webkit-scrollbar-thumb {
            background: var(--terminal-gray-light, #333);
            border: 1px solid var(--terminal-green-dim, #00cc33);
        }

        .value-monitor::-webkit-scrollbar-thumb:hover {
            background: var(--terminal-green-dark, #009929);
            border-color: var(--terminal-green, #00ff41);
        }
    </style>
</head>
<body>
    <!-- Fixed Header -->
    <header class="demo-header">
        <div class="demo-header-content">
            <div class="demo-header-left">
                <h1>TDynamicControlsLit</h1>
                <div class="breadcrumb">
                    <a href="index.html">← Components</a> / Dynamic Controls
                </div>
            </div>
            <div class="demo-header-controls">
                <button class="header-btn" id="toggleLogBtn">▼ Event Log</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="demo-container">
        <div class="component-section">
            <h2 class="component-title">Dynamic Controls</h2>
            <p class="component-description">
                Schema-driven control generation for ViewModel and State Machine data. Supports nested structures, multiple control types, and automatic value binding.
            </p>

            <h3>Simple Schema</h3>
            <div class="demo-grid">
                <div class="demo-item" style="grid-column: span 2;">
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <t-btn id="toggle-disabled" variant="secondary" size="sm">Toggle Disabled</t-btn>
                        <t-btn id="toggle-types" variant="secondary" size="sm">Toggle Type Badges</t-btn>
                    </div>
                    <t-dynamic-controls id="simple-controls"></t-dynamic-controls>
                    <div class="value-monitor">
                        <div class="value-monitor-title">Current Values</div>
                        <pre id="simple-values">{}</pre>
                    </div>
                </div>
            </div>

            <h3>Nested ViewModels (5 Levels)</h3>
            <div class="demo-grid">
                <div class="demo-item" style="grid-column: span 2;">
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <t-btn id="random-update" variant="secondary" size="sm">Randomize Values</t-btn>
                    </div>
                    <t-dynamic-controls id="nested-controls" show-types show-filter></t-dynamic-controls>
                    <div class="value-monitor">
                        <div class="value-monitor-title">Current Values</div>
                        <pre id="nested-values">{}</pre>
                    </div>
                </div>
            </div>

            <h3>State Machine Controls</h3>
            <div class="demo-grid">
                <div class="demo-item" style="grid-column: span 2;">
                    <t-dynamic-controls id="sm-controls"></t-dynamic-controls>
                </div>
            </div>

            <h3>All Control Types</h3>
            <div class="demo-grid">
                <div class="demo-item" style="grid-column: span 2;">
                    <t-dynamic-controls id="all-types-controls" show-types></t-dynamic-controls>
                    <div class="value-monitor">
                        <div class="value-monitor-title">Current Values</div>
                        <pre id="all-types-values">{}</pre>
                    </div>
                </div>
            </div>

            <h3>Extended Control Types (Slider, Progress, Textarea)</h3>
            <div class="demo-grid">
                <div class="demo-item" style="grid-column: span 2;">
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <t-btn id="animate-progress" variant="secondary" size="sm">Animate Progress</t-btn>
                    </div>
                    <t-dynamic-controls id="extended-controls" show-types show-filter></t-dynamic-controls>
                    <div class="value-monitor">
                        <div class="value-monitor-title">Current Values</div>
                        <pre id="extended-values">{}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Log Panel -->
    <div class="event-log-container collapsed" id="eventLogContainer">
        <div class="event-log-toggle" id="eventLogToggle">
            <h3><span class="toggle-icon">▼</span> Event Log</h3>
            <div class="event-log-controls">
                <span class="event-log-count" id="eventCount">0 events</span>
                <button class="event-log-clear" id="clearLogBtn">Clear</button>
            </div>
        </div>
        <div class="event-log" id="eventLogContent"></div>
    </div>

    <script type="module">
        // Import components
        import '../js/components/TButtonLit.js';
        import '../js/components/TInputLit.js';
        import '../js/components/TToggleLit.js';
        import '../js/components/TDropdownLit.js';
        import '../js/components/TColorPickerLit.js';
        import '../js/components/TSliderLit.js';
        import '../js/components/TProgressLit.js';
        import '../js/components/TTextareaLit.js';
        import '../js/components/TDynamicControlsLit.js';

        // Wait for all components
        await Promise.all([
            customElements.whenDefined('t-dynamic-controls'),
            customElements.whenDefined('t-btn'),
            customElements.whenDefined('t-inp'),
            customElements.whenDefined('t-tog'),
            customElements.whenDefined('t-drp'),
            customElements.whenDefined('t-clr'),
            customElements.whenDefined('t-sld'),
            customElements.whenDefined('t-prg'),
            customElements.whenDefined('t-textarea')
        ]);

        // Event log functionality
        const eventLogContainer = document.getElementById('eventLogContainer');
        const eventLogToggle = document.getElementById('eventLogToggle');
        const eventLogContent = document.getElementById('eventLogContent');
        const toggleLogBtn = document.getElementById('toggleLogBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const eventCount = document.getElementById('eventCount');
        let eventCounter = 0;

        function logEvent(eventName, detail) {
            eventCounter++;
            eventCount.textContent = `${eventCounter} events`;

            const entry = document.createElement('div');
            entry.className = 'event-entry';
            const time = new Date().toLocaleTimeString();
            const detailStr = JSON.stringify(detail).substring(0, 60);
            entry.innerHTML = `[${time}] <strong>${eventName}</strong>: ${detailStr}`;
            eventLogContent.insertBefore(entry, eventLogContent.firstChild);
            if (eventLogContent.children.length > 50) {
                eventLogContent.removeChild(eventLogContent.lastChild);
            }
        }

        // Header button toggle
        toggleLogBtn.addEventListener('click', () => {
            eventLogContainer.classList.toggle('collapsed');
            toggleLogBtn.textContent = eventLogContainer.classList.contains('collapsed') ? '▼ Event Log' : '▲ Event Log';
        });

        // Click on toggle bar
        eventLogToggle.addEventListener('click', () => {
            eventLogContainer.classList.toggle('collapsed');
            toggleLogBtn.textContent = eventLogContainer.classList.contains('collapsed') ? '▼ Event Log' : '▲ Event Log';
        });

        clearLogBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            eventLogContent.innerHTML = '';
            eventCounter = 0;
            eventCount.textContent = '0 events';
        });

        // Schema definitions
        const simpleSchema = {
            stateMachines: [{
                name: "MainController",
                inputs: [
                    { name: "isPlaying", type: "boolean", value: false },
                    { name: "progress", type: "number", min: 0, max: 100, value: 50 }
                ]
            }],
            viewModel: {
                name: "AppSettings",
                blueprintName: "Application Settings",
                properties: [
                    { name: "enabled", type: "boolean", value: true },
                    { name: "speed", type: "number", value: 1.0 },
                    { name: "themeColor", type: "color", value: 0xff00ff41 },
                    { name: "mode", type: "enumType", value: "auto", metadata: { enumValues: ["auto", "manual", "hybrid"] } },
                    { name: "title", type: "string", value: "Demo App" },
                    { name: "reset", type: "trigger" }
                ]
            }
        };

        const nestedSchema = {
            viewModel: {
                name: "RootVM",
                blueprintName: "Root Level",
                properties: [{ name: "rootProp", type: "boolean", value: true }],
                nestedViewModels: [{
                    name: "Level1VM",
                    blueprintName: "Level 1",
                    properties: [{ name: "level1Prop", type: "number", value: 1 }],
                    nestedViewModels: [{
                        name: "Level2VM",
                        blueprintName: "Level 2",
                        properties: [
                            { name: "level2Prop", type: "string", value: "Level 2" },
                            { name: "level2Color", type: "color", value: 0xffff0000 }
                        ],
                        nestedViewModels: [{
                            name: "Level3VM",
                            blueprintName: "Level 3",
                            properties: [{ name: "level3Prop", type: "enumType", value: "option1", metadata: { enumValues: ["option1", "option2", "option3"] } }],
                            nestedViewModels: [{
                                name: "Level4VM",
                                blueprintName: "Level 4",
                                properties: [{ name: "level4Prop", type: "boolean", value: false }],
                                nestedViewModels: [{
                                    name: "Level5VM",
                                    blueprintName: "Level 5 (Deepest)",
                                    properties: [
                                        { name: "deepestProp", type: "string", value: "Deep value" },
                                        { name: "deepTrigger", type: "trigger" }
                                    ]
                                }]
                            }]
                        }]
                    }]
                }, {
                    name: "SiblingVM",
                    blueprintName: "Sibling ViewModel",
                    properties: [{ name: "siblingProp", type: "number", value: 42 }]
                }]
            }
        };

        const smOnlySchema = {
            stateMachines: [
                {
                    name: "PlayerController",
                    inputs: [
                        { name: "jump", type: "trigger" },
                        { name: "moveSpeed", type: "number", min: 0, max: 10, step: 0.5, value: 5 },
                        { name: "isGrounded", type: "boolean", value: true }
                    ]
                },
                {
                    name: "AnimationController",
                    inputs: [
                        { name: "play", type: "trigger" },
                        { name: "pause", type: "trigger" },
                        { name: "animSpeed", type: "number", min: 0.1, max: 2.0, step: 0.1, value: 1.0 }
                    ]
                }
            ]
        };

        const allTypesSchema = {
            viewModel: {
                name: "AllTypesVM",
                blueprintName: "All Control Types",
                properties: [
                    { name: "booleanCtrl", type: "boolean", value: false },
                    { name: "numberCtrl", type: "number", value: 3.14159 },
                    { name: "stringCtrl", type: "string", value: "Hello Terminal" },
                    { name: "colorCtrl", type: "color", value: 0xff00ff41 },
                    { name: "enumCtrl", type: "enumType", value: "medium", metadata: { enumValues: ["small", "medium", "large", "xl"] } },
                    { name: "triggerCtrl", type: "trigger" }
                ]
            }
        };

        const extendedSchema = {
            viewModel: {
                name: "ExtendedTypesVM",
                blueprintName: "Extended Control Types",
                properties: [
                    { name: "volume", type: "slider", value: 75, min: 0, max: 100, step: 1 },
                    { name: "brightness", type: "slider", value: 50, min: 0, max: 100, step: 5 },
                    { name: "downloadProgress", type: "progress", value: 65, max: 100 },
                    { name: "uploadProgress", type: "progress", value: 30, max: 100 },
                    { name: "description", type: "textarea", value: "Enter your description here...\nSupports multiple lines.", rows: 4 },
                    { name: "notes", type: "textarea", value: "Additional notes", rows: 2, resize: "both" }
                ],
                nestedViewModels: [{
                    name: "AudioSettings",
                    blueprintName: "Audio Settings",
                    properties: [
                        { name: "masterVolume", type: "slider", value: 80, min: 0, max: 100 },
                        { name: "bassBoost", type: "slider", value: 25, min: 0, max: 100 },
                        { name: "treble", type: "slider", value: 50, min: 0, max: 100 },
                        { name: "muted", type: "boolean", value: false }
                    ]
                }, {
                    name: "TaskProgress",
                    blueprintName: "Task Progress",
                    properties: [
                        { name: "task1", type: "progress", value: 100, max: 100 },
                        { name: "task2", type: "progress", value: 75, max: 100 },
                        { name: "task3", type: "progress", value: 25, max: 100 },
                        { name: "task4", type: "progress", value: 0, max: 100 }
                    ]
                }]
            }
        };

        // Initialize controls
        const simpleControls = document.getElementById('simple-controls');
        const nestedControls = document.getElementById('nested-controls');
        const smControls = document.getElementById('sm-controls');
        const allTypesControls = document.getElementById('all-types-controls');
        const extendedControls = document.getElementById('extended-controls');

        simpleControls.setSchema(simpleSchema);
        nestedControls.setSchema(nestedSchema);
        smControls.setSchema(smOnlySchema);
        allTypesControls.setSchema(allTypesSchema);
        extendedControls.setSchema(extendedSchema);

        // Value displays
        const simpleValues = document.getElementById('simple-values');
        const nestedValues = document.getElementById('nested-values');
        const allTypesValues = document.getElementById('all-types-values');
        const extendedValues = document.getElementById('extended-values');

        function updateDisplay(el, pre) {
            pre.textContent = JSON.stringify(el.getValues(), null, 2);
        }

        // Initial display
        updateDisplay(simpleControls, simpleValues);
        updateDisplay(nestedControls, nestedValues);
        updateDisplay(allTypesControls, allTypesValues);
        updateDisplay(extendedControls, extendedValues);

        // Event listeners for all controls
        [simpleControls, nestedControls, smControls, allTypesControls, extendedControls].forEach(ctrl => {
            ctrl.addEventListener('control-change', (e) => {
                logEvent('control-change', e.detail);
            });
            ctrl.addEventListener('control-trigger', (e) => {
                logEvent('control-trigger', e.detail);
            });
        });

        simpleControls.addEventListener('control-change', () => updateDisplay(simpleControls, simpleValues));
        nestedControls.addEventListener('control-change', () => updateDisplay(nestedControls, nestedValues));
        allTypesControls.addEventListener('control-change', () => updateDisplay(allTypesControls, allTypesValues));
        extendedControls.addEventListener('control-change', () => updateDisplay(extendedControls, extendedValues));

        // Button handlers
        document.getElementById('toggle-disabled').addEventListener('button-click', () => {
            if (simpleControls.disabled) {
                simpleControls.enable();
            } else {
                simpleControls.disable();
            }
        });

        document.getElementById('toggle-types').addEventListener('button-click', () => {
            simpleControls.showTypes = !simpleControls.showTypes;
        });

        document.getElementById('random-update').addEventListener('button-click', () => {
            nestedControls.updateValue('vm.RootVM.rootProp', Math.random() > 0.5);
            nestedControls.updateValue('vm.Level1VM.level1Prop', Math.round(Math.random() * 100));
            nestedControls.updateValue('vm.Level2VM.level2Prop', `Random-${Date.now()}`);
            nestedControls.updateValue('vm.Level2VM.level2Color', 0xff000000 | Math.floor(Math.random() * 0xffffff));
            updateDisplay(nestedControls, nestedValues);
        });

        // Animate progress bars
        let animationId = null;
        document.getElementById('animate-progress').addEventListener('button-click', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
                return;
            }

            let start = performance.now();
            const animate = (now) => {
                const elapsed = (now - start) / 50;
                const progress1 = Math.round(elapsed % 100);
                const progress2 = Math.round((elapsed * 0.7) % 100);

                extendedControls.updateValue('vm.ExtendedTypesVM.downloadProgress', progress1);
                extendedControls.updateValue('vm.ExtendedTypesVM.uploadProgress', progress2);
                extendedControls.updateValue('vm.TaskProgress.task3', Math.round((elapsed * 0.5) % 100));
                extendedControls.updateValue('vm.TaskProgress.task4', Math.round((elapsed * 0.3) % 100));

                updateDisplay(extendedControls, extendedValues);
                animationId = requestAnimationFrame(animate);
            };
            animationId = requestAnimationFrame(animate);
        });
    </script>
    <script type="module" src="../js/utils/demo-color-picker.js"></script>
</body>
</html>
